#include <stdio.h>
#include <stdlib.h>

long count(FILE* f) {
  long ptr = ftell(f), cnt = 0;
  fseek(f, 0, 0);
  while(fgetc(f) != -1) ++cnt;
  fseek(f, ptr, 0);
  return cnt;
}

int main(int argc, char **argv) {
  if (argc != 2) {
    printf("pass path to quine - src buffer will be appended as 's[]'\n");
    return 1;
  }

  FILE *f;
  fopen_s(&f, *(argv + 1), "r+");

  long fcount = count(f);
  printf("fcount: %ld\n", fcount);
  unsigned long long padding = 18 + (4 * fcount);
  char* buff = malloc((fcount + padding) * sizeof(char));

  int length = 0, ch;
  length += sprintf(buff + length, "char s[] = {\n");
  while ((ch = fgetc(f)) != -1) {
    length += sprintf(buff + length, "\t%d,\n", ch);
  }
  length += sprintf(buff + length, "};\n\n");

  printf("%s", buff);
  fseek(f, 0, 0);
  fprintf(f, "%s", buff);

  free(buff);
  fclose(f);

  return 0;
}
